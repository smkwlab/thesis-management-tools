name: ğŸ“š å­¦ç”Ÿè«–æ–‡ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ

on:
  workflow_dispatch:
    inputs:
      student_id:
        description: 'ğŸ“ ã‚ãªãŸã®å­¦ç±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: k21rs001)'
        required: true
        type: string

jobs:
  create-thesis-repo:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ å…¥åŠ›æƒ…å ±ã®ç¢ºèª
        run: |
          echo "å­¦ç±ç•ªå·: ${{ github.event.inputs.student_id }}"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo "çµ„ç¹”: ${{ github.repository_owner }}"

      - name: ğŸ“ è«–æ–‡ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å­¦ç±ç•ªå·ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª
          if [[ "${{ github.event.inputs.student_id }}" =~ ^k[0-9]{2}(rs[0-9]{3}|gjk[0-9]{2})$ ]]; then
            echo "âœ… å­¦ç±ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèªå®Œäº†"
          else
            echo "âŒ å­¦ç±ç•ªå·ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # Docker ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          docker run --rm \
            -e GITHUB_TOKEN="$GITHUB_TOKEN" \
            -e GITHUB_REPOSITORY="$GITHUB_REPOSITORY" \
            -e GITHUB_ACTOR="${{ github.actor }}" \
            smkwlab/thesis-setup:latest \
            "${{ github.event.inputs.student_id }}"

      - name: ğŸ“§ å­¦ç”Ÿã‚’ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦è¿½åŠ 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STUDENT_ID="${{ github.event.inputs.student_id }}"
          if [[ "$STUDENT_ID" =~ k[0-9]{2}rs[0-9]{3} ]]; then
            REPO_NAME="${STUDENT_ID}-sotsuron"
          else
            REPO_NAME="${STUDENT_ID}-thesis"
          fi
          
          # å­¦ç”Ÿã‚’ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦è¿½åŠ 
          gh api repos/${{ github.repository_owner }}/${REPO_NAME}/collaborators/${{ github.actor }} \
            --method PUT \
            --field permission=write
          
          echo "âœ… ${{ github.actor }} ã‚’ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦è¿½åŠ ã—ã¾ã—ãŸ"

      - name: ğŸ‰ å®Œäº†é€šçŸ¥
        run: |
          STUDENT_ID="${{ github.event.inputs.student_id }}"
          if [[ "$STUDENT_ID" =~ k[0-9]{2}rs[0-9]{3} ]]; then
            REPO_NAME="${STUDENT_ID}-sotsuron"
          else
            REPO_NAME="${STUDENT_ID}-thesis"
          fi
          
          echo "ğŸ‰ è«–æ–‡ãƒªãƒã‚¸ãƒˆãƒªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo ""
          echo "ğŸ“ ä½œæˆã•ã‚ŒãŸãƒªãƒã‚¸ãƒˆãƒª:"
          echo "   https://github.com/${{ github.repository_owner }}/${REPO_NAME}"
          echo ""
          echo "ğŸ“‹ æ¬¡ã®æ‰‹é †:"
          echo "1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³:"
          echo "   git clone https://github.com/${{ github.repository_owner }}/${REPO_NAME}.git"
          echo "2. VS Code ã§é–‹ã: code ${REPO_NAME}"
          echo "3. 'Reopen in Container' ã‚’é¸æŠ"
          echo ""
          echo "ğŸ“– è©³ã—ã„ä½¿ã„æ–¹:"
          echo "   https://github.com/${{ github.repository_owner }}/thesis-management-tools/blob/main/docs/WRITING-GUIDE.md"